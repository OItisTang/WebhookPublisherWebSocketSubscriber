<!DOCTYPE html>
<html>
<head>
<title>WebSocketSubscriberClient</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="icon.png">
<!--
<script src="https://cdn.rawgit.com/OItisTang/WebhookPublisherWebSocketSubscriber/main/WebSocketSubscriberClient/Logger.js"></script>
<script src="https://cdn.rawgit.com/OItisTang/WebhookPublisherWebSocketSubscriber/main/WebSocketSubscriberClient/WebSocketSubscriber.js"></script>
-->
<script src="Logger.js"></script>
<script src="WebSocketSubscriber.js"></script>
<link rel="stylesheet" href="https://rawgit.com/summerstyle/jsonTreeViewer/master/libs/jsonTree/jsonTree.css">
<script src="https://rawgit.com/summerstyle/jsonTreeViewer/master/libs/jsonTree/jsonTree.js"></script>
<script type="text/javascript">
	// ---------------------
	// vendor
	// ---------------------
	function findGetParameter(parameterName) {
		var result = "";
		var kvPair = [];
		location.search
			.substr(1) // eat "?" character
			.split("&")
			.forEach(function(item) {
				kvPair = item.match(/(.*?)=(.*)/);
				if (kvPair[1] === parameterName) result = decodeURIComponent(kvPair[2]);
			});
		return result;
	}
	
	// ---------------------
	// UI
	// ---------------------
	class UiView {
		constructor(onSubscribeCallback, onUnsubscribeCallback, onUnsubscribeAllCallback) {
			this.onSubscribeCallback = onSubscribeCallback;
			this.onUnsubscribeCallback = onUnsubscribeCallback;
			this.onUnsubscribeAllCallback = onUnsubscribeAllCallback;
		}

		setServerMethodAndStatus(serverMethod, serverStatus) {
			document.getElementById("serverMethod").innerHTML = serverMethod;

			document.getElementById("serverStatusIndicator").classList.remove("open");
			document.getElementById("serverStatusIndicator").classList.remove("error");
			document.getElementById("serverStatusIndicator").classList.remove("close");
			document.getElementById("serverStatusIndicator").classList.add(serverStatus);
		}

		log(logMessageClass, msg) {
			var logMessages = document.getElementById('logMessages');
			if (logMessages.children.length >= 50) {
				logMessages.removeChild(
					logMessages.getElementsByTagName('div')[0]
				);
			}
			
			var newElement = document.createElement('div');
			newElement.innerHTML = msg;
			newElement.classList.add(logMessageClass);
			logMessages.appendChild(newElement);
		}

		clearInput() {
			document.getElementById("subscribeKey").value = "";
		}

		addSubscribeKeyOption(key) {
			this.removeSubscribeKeyOption(key);

			var keysDatalist = document.getElementById('subscribeKeys');
			var option = document.createElement('option');
			option.value = key;
			keysDatalist.appendChild(option);
		}

		removeSubscribeKeyOption(key) {
			var keysDatalist = document.getElementById('subscribeKeys');
			for(var i=keysDatalist.options.length-1; i>=0; i--) {
				if(keysDatalist.options[i].value == key){
					keysDatalist.children[i].remove();
					break;
				}
			}
		}

		showMessage(info, msgObj = null) {
			var messageInfoDiv = document.getElementById("messageInfo");
			messageInfoDiv.innerHTML = info;

			if (msgObj) {
				var messageDataDiv = document.getElementById("messageData");
				while (messageDataDiv.firstChild) {
					messageDataDiv.removeChild(messageDataDiv.firstChild);
				}
				this.msgObjTree = jsonTree.create(msgObj, messageDataDiv);
				this.msgObjTree.expand();
			}
		}

		_prepareMainUiEventHandlers() {
			document.getElementById("serverStatusIndicator").onclick = function() {
				var log = document.getElementById('log');
				if (log.style.display === "none") {
					log.style.display = "block";
				} else {
					log.style.display = "none";
				}
			};

			var that = this;
			
			document.getElementById("subscribeBtn").onclick = function() {
				var key = document.getElementById("subscribeKey").value;
				if (key != "") {
					if (that.onSubscribeCallback) that.onSubscribeCallback(key);
				}
			};

			document.getElementById("unsubscribeBtn").onclick = function() {
				var key = document.getElementById("subscribeKey").value;
				if (key != "") {
					if (that.onUnsubscribeCallback) that.onUnsubscribeCallback(key);
				}
			};

			document.getElementById("unsubscribeAllBtn").onclick = function() {
				var keyOptions = document.getElementById('subscribeKeys').getElementsByTagName('option');
				var keys = [];
				for (var i=0; i<keyOptions.length; i++) {
					keys.push(keyOptions[i].value);
				}
				if (keys.length > 0) {
					if (that.onUnsubscribeAllCallback) that.onUnsubscribeAllCallback(keys);
				}
			};
		}

		start() {
			this._prepareMainUiEventHandlers();
		}
	}

	// ---------------------
	// app
	// ---------------------
	class WebSocketSubscriberClientApp {
		constructor(autoSubscribeKey) {
			this.autoSubscribeKey = autoSubscribeKey;
		}

		_onUi_Subscribe(key) {
			this.view.clearInput();
			this.webSocketSubscriber.subscribe(key);
		}

		_onUi_Unsubscribe(key) {
			this.view.clearInput();
			this.webSocketSubscriber.unsubscribe(key);
		}

		_onUi_UnsubscribeAll(keys) {
			this.view.clearInput();
			
			var that = this;
			keys.forEach(function (key) {
				that.webSocketSubscriber.unsubscribe(key);
			});
		}

		_onLogger_Log(logMessageClass, msg) {
			var firstLine = msg.split('\n')[0];
			this.view.log(logMessageClass, firstLine);
		}

		_onSubscriber_WelcomeMsg(msgObj) {
			var info = "received [" + msgObj.type + "] message, connId: [" + msgObj.value.connectionId + "]";
			this.view.showMessage(info, msgObj);

			if (this.autoSubscribeKey != "") {
				this.webSocketSubscriber.subscribe(this.autoSubscribeKey);
			}
		}

		_onSubscriber_PublishMsg(msgObj) {
			this.updateTimestamp = msgObj.date;
			var info = msgObj.date + " - received [" + msgObj.type + "] message for key: [" + msgObj.key + "]";
			this.view.showMessage(info, msgObj);
		}

		_onSubscriber_SubscribeSuccessMsg(msgObj) {
			if (msgObj.value.cachedPublishData) {
				this.updateTimestamp = msgObj.value.cachedPublishData.date;
			}
			var info = "received [" + msgObj.type + "] message for key: [" + msgObj.value.key + "]";
			this.view.addSubscribeKeyOption(msgObj.value.key);
			this.view.showMessage(info, msgObj);
		}

		_onSubscriber_UnsubscribeSuccessMsg(msgObj) {
			var info = "received [" + msgObj.type + "] message for key: [" + msgObj.value.key + "]";
			this.view.removeSubscribeKeyOption(msgObj.value.key);
			this.view.showMessage(info, msgObj);
		}

		_onSubscriber_StatusUpdate(status) {
			this.view.setServerMethodAndStatus("Push", status);
		}

		start() {
			var that = this;

			// create modules
			Logger.setLogCallback(function(logMessageClass, msg) {
				that._onLogger_Log(logMessageClass, msg);
			});

			this.view = new UiView(function(key) {
				that._onUi_Subscribe(key);
			}, function(key) {
				that._onUi_Unsubscribe(key);
			}, function(keys) {
				that._onUi_UnsubscribeAll(keys);
			});

			this.webSocketSubscriber = new WebSocketSubscriber(
				'wss://149.28.204.205:8081',
				{
					onWelcomeMsgCallback : function(msgObj) {
						that._onSubscriber_WelcomeMsg(msgObj);
					},
					onPublishMsgCallback : function(msgObj) {
						that._onSubscriber_PublishMsg(msgObj);
					},
					onSubscribeSuccessMsgCallback : function(msgObj) {
						that._onSubscriber_SubscribeSuccessMsg(msgObj);
					},
					onUnsubscribeSuccessMsgCallback : function(msgObj) {
						that._onSubscriber_UnsubscribeSuccessMsg(msgObj);
					},
					onStatusUpdateCallback : function(status) {
						that._onSubscriber_StatusUpdate(status);
					},
				},
				Logger
			);
			
			// some preparing work
			this.view.start();

			// start receiving updates
			this.webSocketSubscriber.start();
		}
	}

	// ---------------------
	// HTML start
	// ---------------------
	window.onload = function() {
		var autoSubscribeKey = findGetParameter("key");

		var webSocketSubscriberClientApp = new WebSocketSubscriberClientApp(autoSubscribeKey);
		webSocketSubscriberClientApp.start();
		
		window.app = webSocketSubscriberClientApp;
	};
</script>
<style>
	body {
		background-color: #154f85;
		font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Droid Sans,Helvetica Neue,sans-serif;
	}
	a {
		color: black;
	}
	#main {
		display: flex;
		flex-direction: column;
		height: 97vh;
	}
	#topBar {
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-left: 6px;
		margin-right: 6px;
	}
	#logo {
		margin-top: 3px;
	}
	.logoImg {
		width: 18px;
		height: 18px;
	}
	#subscriptionMgr {
		text-align: center;
		color: #1A2744;
	}
	.keyInput {
		border-radius: 4px;
		border: none;
		background-color: #F3F3F6;
	}
	.actionBtn {
		border-radius: 4px;
		border: none;
		background-color: #F3F3F6;
		cursor: pointer;
	}
	#serverStatus {
		color: white;
		font-size: smaller;
	}
	.serverStatusIndicator {
		background-color: grey;
		border-radius: 50%;
		width: 10px;
		height: 10px;
		display: inline-block;
		cursor: pointer;
	}
	.serverStatusIndicator.open {
		background-color: green;
	}
	.serverStatusIndicator.error {
		background-color: red;
	}
	.serverStatusIndicator.close {
		background-color: grey;
	}
	#contentArea {
		margin-top: 4px;
		flex-grow: 1;
		overflow: scroll;
		border-radius: 6px;
		margin-left: 10px;
		margin-right: 10px;
		background-color: white;
		overflow: scroll;
	}
	#messageInfo {
		margin-left: 8px;
		margin-top: 6px;
	}
	.jsontree_tree {
		margin-left: -20px;
	}
	#log {
		color: white;
		position: fixed;
		background-color: #282828e6;
		left: 0px;
		top: 36px;
		width: 100%;
		height: 90%;
		overflow-y: scroll;
		font-size: x-small;
	}
	#log a {
		color: white;
	}
	#logMessages {
		margin-left: 8px;
		margin-right: 12px;
	}
	#logMessages > .error {
		color: rgba(246, 138, 138, 1);
	}
	#logMessages > .info {
		color: rgba(108, 148, 255, 1);
	}
	#logMessages > .debug {
		color: rgba(0, 201, 201, 1);
	}
</style>
</head>
<body>
	<div id="main">
		<div id="topBar">
			<div id="logo">
				<img class="logoImg" id="logoImg" src="icon.png">
			</div>
			<div id="subscriptionMgr">
				<input type="text" id="subscribeKey" class="keyInput" list="subscribeKeys" placeholder="subscribe a key to receive updates" size="48">
				<datalist id="subscribeKeys"></datalist>
				<input type="button" id="subscribeBtn" class="actionBtn" value=" + ">
				<input type="button" id="unsubscribeBtn" class="actionBtn" value=" - ">
				<input type="button" id="unsubscribeAllBtn" class="actionBtn" value=" x ">
			</div>
			<div id="serverStatus">
				<span class="serverMethod" id="serverMethod"></span>
				<span class="serverStatusIndicator" id="serverStatusIndicator"></span>
			</div>
		</div>
		<div id="contentArea">
			<div id="messageInfo">waiting for message ...</div>
			<hr>
			<div id="messageData"></div>
		</div>
	</div>
	<div id="log" style="display: none;">
		<h2>Log</h2>
		<div id="logMessages"></div>
	</div>
</body>
</html>
